# Docker Compose for Development Environment
# Phase: WOR-12 - Docker Containerization
# Purpose: Local development with all services (Claude Code, Bedrock Proxy, optional Gateway)

version: '3.8'

services:
  # =========================================================================
  # Claude Code + Bedrock Proxy Server
  # =========================================================================
  claude-code:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_DATE: "${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}"
        VCS_REF: "${VCS_REF:-main}"
        VERSION: "${VERSION:-1.0.0}"

    container_name: claude-code-bedrock-proxy

    # Restart policy for development
    restart: unless-stopped

    # Port mappings
    ports:
      # Bedrock Proxy Server (OpenAI-compatible API)
      - "3000:3000"

    # Environment variables
    environment:
      # AWS Configuration
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN:-}

      # Node environment
      NODE_ENV: development
      LOG_LEVEL: debug

      # Bedrock configuration
      BEDROCK_REGION: ${AWS_REGION:-us-east-1}

      # Gateway configuration
      ENABLE_GATEWAY: "true"
      GATEWAY_CACHE_TTL: "3600"
      GATEWAY_COST_OPTIMIZATION: "true"

      # Logging
      DEBUG: "bedrock:*"

    # Volume mounts for development
    volumes:
      # Configuration (allow live reload)
      - ./.claude/bedrock.config.yaml:/app/.claude/bedrock.config.yaml:ro

      # Source code (for nodemon auto-reload if configured)
      - ./src:/app/src:ro

      # Scripts
      - ./scripts:/app/scripts:ro

      # Logs (persist for inspection)
      - ./logs:/app/logs

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=claude-code"

    # Resource limits for development
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Security options
    security_opt:
      - no-new-privileges:true

    # Override command for development (optional)
    # command: npm run dev:proxy

  # =========================================================================
  # Optional: LLM Gateway (for advanced routing)
  # =========================================================================
  # Uncomment to enable intelligent model routing and cost optimization
  # gateway:
  #   build:
  #     context: .
  #     dockerfile: docker/Dockerfile.gateway
  #   container_name: claude-gateway
  #   ports:
  #     - "3001:3001"
  #   environment:
  #     NODE_ENV: development
  #     GATEWAY_PORT: 3001
  #     LOG_LEVEL: debug
  #   depends_on:
  #     claude-code:
  #       condition: service_healthy
  #   volumes:
  #     - ./.claude/bedrock.config.yaml:/app/.claude/bedrock.config.yaml:ro

  # =========================================================================
  # Optional: Monitoring/Metrics (for observability)
  # =========================================================================
  # Uncomment to enable Prometheus metrics collection
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: claude-prometheus
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'

# =========================================================================
# Volumes (persistent storage)
# =========================================================================
volumes:
  # Uncomment if using Prometheus
  # prometheus-data:
  #   driver: local

# =========================================================================
# Networks
# =========================================================================
networks:
  default:
    name: claude-code-network
    driver: bridge

# =========================================================================
# Usage
# =========================================================================
# Start all services:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f claude-code
#
# Test proxy server:
#   curl http://localhost:3000/health
#   curl http://localhost:3000/v1/models
#
# Stop all services:
#   docker-compose down
#
# Rebuild image:
#   docker-compose build --no-cache
#
# Run specific command:
#   docker-compose exec claude-code npm run test:bedrock
